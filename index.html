<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Distributed URL Router</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1f2933, #020617 55%);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      max-width: 520px;
      width: 100%;
      padding: 1.5rem;
      box-sizing: border-box;
      text-align: center;
    }

    .big-button {
      width: 100%;
      padding: 1.2rem 1.5rem;
      border-radius: 999px;
      border: none;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      cursor: pointer;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: #fff;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      transition:
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out,
        filter 0.12s ease-out,
        opacity 0.12s ease-out;
    }

    .big-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      filter: grayscale(0.3);
    }

    .big-button:not(:disabled):active {
      transform: translateY(2px) scale(0.99);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
      filter: brightness(0.95);
    }

    .status {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #cbd5f5;
      min-height: 1.4em;
      word-break: break-word;
    }

    .status.error {
      color: #fca5a5;
    }

    .status code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    details {
      margin-top: 1.5rem;
      text-align: left;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 1rem;
      padding: 0.6rem 0.9rem 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    summary {
      cursor: pointer;
      outline: none;
      list-style: none;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      user-select: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .summary-chevron {
      width: 0.75rem;
      height: 0.75rem;
      border-right: 2px solid #e5e7eb;
      border-bottom: 2px solid #e5e7eb;
      transform: rotate(45deg);
      transition: transform 0.12s ease-out;
      flex-shrink: 0;
    }

    details[open] .summary-chevron {
      transform: rotate(225deg);
    }

    .panel-body {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #d1d5db;
    }

    .mode-select {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin: 0.6rem 0 0.8rem;
    }

    .mode-option {
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .mode-option input[type="radio"] {
      accent-color: #8b5cf6;
    }

    label {
      font-size: 0.9rem;
    }

    .field {
      margin-top: 0.75rem;
    }

    .field label {
      display: block;
      margin-bottom: 0.35rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.45rem 0.7rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 1px rgba(139, 92, 246, 0.7);
    }

    .hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.3rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="go-btn" class="big-button" disabled>
      Let’s go
    </button>

    <div id="status" class="status">
      Looking for <code>?csv=…</code> parameter…
    </div>

    <details>
      <summary>
        <span class="summary-chevron"></span>
        Advanced options
      </summary>
      <div class="panel-body">
        <p>
          This page distributes people across a set of URLs defined in a CSV file,
          whose address is passed via the <code>?csv=…</code> parameter.
        </p>

        <div class="mode-select">
          <div class="mode-option">
            <input type="radio" id="mode-random" name="mode" value="random" checked />
            <label for="mode-random">
              <strong>Random (balanced)</strong> — each device is stably assigned to one of the URLs.
            </label>
          </div>
          <div class="mode-option">
            <input type="radio" id="mode-code" name="mode" value="code" />
            <label for="mode-code">
              Use a code (e.g. <code>purple</code>) to go to a specific destination.
            </label>
          </div>
        </div>

        <div class="field">
          <label for="code-input">Code (only used if “Use a code” is selected):</label>
          <input
            id="code-input"
            type="text"
            placeholder="e.g. purple"
            autocomplete="off"
          />
          <div class="hint">
            The CSV should have <code>code</code> and <code>url</code> columns. Empty codes are allowed.
          </div>
        </div>
      </div>
    </details>
  </div>

  <script>
    let links = [];
    let codeMap = {};
    let urls = [];

    const statusEl = document.getElementById("status");
    const goBtn = document.getElementById("go-btn");
    const codeInput = document.getElementById("code-input");
    const modeRandom = document.getElementById("mode-random");
    const modeCode = document.getElementById("mode-code");

    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash * 31 + str.charCodeAt(i)) | 0;
      }
      return hash >>> 0;
    }

    function getUserId() {
      const key = "distributeurl_user_id";
      let id = localStorage.getItem(key);
      if (!id) {
        if (window.crypto && crypto.randomUUID) {
          id = crypto.randomUUID();
        } else {
          id = Date.now().toString(36) + "-" + Math.random().toString(36).slice(2);
        }
        localStorage.setItem(key, id);
      }
      return id;
    }

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim() !== "");
      if (lines.length === 0) return [];

      const header = lines[0].split(",");
      const idxCode = header.findIndex((h) => h.trim().toLowerCase() === "code");
      const idxUrl = header.findIndex((h) => h.trim().toLowerCase() === "url");

      if (idxUrl === -1) {
        throw new Error('CSV must contain a "url" column');
      }

      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        const code = idxCode >= 0 ? (cols[idxCode] || "").trim() : "";
        const url = (cols[idxUrl] || "").trim();
        if (!url) continue;
        rows.push({ code, url });
      }
      return rows;
    }

    async function loadCsvFromParam() {
      const params = new URLSearchParams(window.location.search);
      const csvUrl = params.get("csv");

      if (!csvUrl) {
        statusEl.innerHTML =
          'Missing <code>?csv=…</code> parameter in the URL. ' +
          "Call this page like:<br><code>?csv=https%3A%2F%2F…%2Foutput%3Dcsv</code>";
        statusEl.classList.add("error");
        goBtn.disabled = true;
        return;
      }

      statusEl.textContent = "Loading CSV from parameter…";

      try {
        const res = await fetch(csvUrl, { cache: "no-cache" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const text = await res.text();
        const data = parseCsv(text);

        if (!Array.isArray(data) || data.length === 0) {
          throw new Error("Empty or invalid CSV");
        }

        links = data;
        codeMap = {};
        urls = [];

        for (const entry of links) {
          const code = (entry.code || "").trim().toLowerCase();
          const url = (entry.url || "").trim();
          if (!url) continue;
          urls.push(url);
          if (code) {
            codeMap[code] = url;
          }
        }

        if (urls.length === 0) {
          throw new Error("No valid URLs found in CSV");
        }

        statusEl.textContent = "Ready. Tap “Let’s go”.";
        statusEl.classList.remove("error");
        goBtn.disabled = false;
      } catch (err) {
        console.error(err);
        statusEl.innerHTML =
          "Could not load or parse CSV from:<br><code>" +
          csvUrl +
          "</code><br>" +
          "Error: " +
          err.message;
        statusEl.classList.add("error");
        goBtn.disabled = true;
      }
    }

    function redirectTo(url) {
      statusEl.textContent = "Redirecting…";
      window.location.href = url;
    }

    function handleGoClick() {
      if (urls.length === 0) {
        statusEl.textContent = "No URLs available.";
        statusEl.classList.add("error");
        return;
      }

      const mode = modeCode && modeCode.checked ? "code" : "random";

      if (mode === "code") {
        const code = codeInput.value.trim().toLowerCase();
        if (!code) {
          statusEl.textContent = "Please enter a code.";
          statusEl.classList.add("error");
          return;
        }
        const url = codeMap[code];
        if (!url) {
          statusEl.textContent = `No URL found for code “${code}”.`;
          statusEl.classList.add("error");
          return;
        }
        statusEl.textContent = `Using code “${code}”…`;
        statusEl.classList.remove("error");
        redirectTo(url);
      } else {
        const userId = getUserId();
        const idx = hashString(userId) % urls.length;
        const url = urls[idx];
        statusEl.textContent = "Assigning you to a URL…";
        statusEl.classList.remove("error");
        redirectTo(url);
      }
    }

    goBtn.addEventListener("click", handleGoClick);

    if (codeInput) {
      codeInput.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          handleGoClick();
        }
      });
    }

    loadCsvFromParam();
  </script>
</body>
</html>
